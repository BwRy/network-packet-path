# network-packet-path
详细展示一个包是怎么从数据到网卡收发的过程



数据发送：

```
	       +-------------+
               | Application |
               +-------------+
                     |
                     |
                     ↓
+------------------------------------------+
| socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP) |
+------------------------------------------+
                     |
                     |
                     ↓
           +-------------------+
           | sendto(sock, ...) |
           +-------------------+
                     |
                     |
                     ↓
              +--------------+
              | inet_sendmsg |
              +--------------+
                     |
                     |
                     ↓
             +---------------+
             | inet_autobind |
             +---------------+
                     |
                     |
                     ↓
               +-----------+
               | UDP layer |
               +-----------+
		     |
                     |
                     ↓
              +-------------+
              | udp_sendmsg |
              +-------------+
                     |
                     |
                     ↓
          +----------------------+
          | ip_route_output_flow |
          +----------------------+
                     |
                     |
                     ↓
              +-------------+
              | ip_make_skb |
              +-------------+
                     |
                     |
                     ↓
         +------------------------+
         | udp_send_skb(skb, fl4) |
         +------------------------+
                     |
                     |
                     ↓
                +----------+
                | IP layer |
                +----------+
		     |
		     |
		     ↓
	      +-------------+
	      | ip_send_skb |
	      +-------------+
		     |
		     |
		     ↓
	   +-------------------+       +-------------------+       +---------------+
	   | __ip_local_out_sk |------>| NF_INET_LOCAL_OUT |------>| dst_output_sk |
	   +-------------------+       +-------------------+       +---------------+
									   |
 									   |
									   ↓
	  +------------------+        +----------------------+       +-----------+
	  | ip_finish_output |<-------| NF_INET_POST_ROUTING |<------| ip_output |
          +------------------+        +----------------------+       +-----------+
		    |
		    |
		    ↓
          +-------------------+      +------------------+       +----------------------+
          | ip_finish_output2 |----->| dst_neigh_output |------>| neigh_resolve_output |
          +-------------------+      +------------------+       +----------------------+
									  |
									  |
								          |
							                  |
									  ↓
								  +----------------+
						 +----------------| dev_queue_xmit |
					         |                +----------------+
						 |                       |
						 |                       |
					         |                       ↓
						 |              +-----------------+
						 |              | Traffic Control |
						 |              +-----------------+
					         | loopback              |
						 |   or                  +--------------------------------------------------------------+
					         | IP tunnels            ↓                                                              |
						 |                       ↓                                                              |
						 |            +---------------------+  Failed   +----------------------+         +---------------+
				                 +----------->| dev_hard_start_xmit |---------->| raise NET_TX_SOFTIRQ |- - - - >| net_tx_action |
						              +---------------------+           +----------------------+         +---------------+
		 								                                                        |
														         +----------------------------------+
															 |                                  |
															 ↓                                  ↓
														+----------------+              +------------------------+
														| ndo_start_xmit |              | packet taps(AF_PACKET) |
														+----------------+              +------------------------+
```



数据接收:

```
                   +-----+
                   |     |                            Memroy
+--------+   1     |     |  2  DMA     +--------+--------+--------+--------+
| Packet |-------->| NIC |------------>| Packet | Packet | Packet | ...... |
+--------+         |     |             +--------+--------+--------+--------+
                   |     |<--------+
                   +-----+         |
                      |            +---------------+
                      |                            |
                    3 | Raise IRQ                  | Disable IRQ
                      |                          5 |
                      |                            |
                      ↓                            |
                   +-----+                   +------------+
                   |     |  Run IRQ handler  |            |
                   | CPU |------------------>| NIC Driver |
                   |     |       4           |            |
                   +-----+                   +------------+
                                                   |
                                                6  | Raise soft IRQ
                                                   |
                                                   ↓
						   

                                                     +-----+
                                             17      |     |
                                        +----------->| NIC |
                                        |            |     |
                                        |Enable IRQ  +-----+
                                        |
                                        |
                                  +------------+                                      Memroy
                                  |            |        Read           +--------+--------+--------+--------+
                 +--------------->| NIC Driver |<--------------------- | Packet | Packet | Packet | ...... |
                 |                |            |          9            +--------+--------+--------+--------+
                 |                +------------+
                 |                      |    |        skb
            Poll | 8      Raise softIRQ | 6  +-----------------+
                 |                      |             10       |
                 |                      ↓                      ↓
         +---------------+  Call  +-----------+        +------------------+        +--------------------+  12  +---------------------+
         | net_rx_action |<-------| ksoftirqd |        | napi_gro_receive |------->| enqueue_to_backlog |----->| CPU input_pkt_queue |
         +---------------+   7    +-----------+        +------------------+   11   +--------------------+      +---------------------+
                                                               |                                                      | 13
                                                            14 |        + - - - - - - - - - - - - - - - - - - - - - - +
                                                               ↓        ↓
                                                    +--------------------------+    15      +------------------------+
                                                    | __netif_receive_skb_core |----------->| packet taps(AF_PACKET) |
                                                    +--------------------------+            +------------------------+
                                                               |
                                                               | 16
                                                               ↓
                                                      +-----------------+
                                                      | protocol layers |
                                                      +-----------------+
						        |
							|
							↓         promiscuous mode &&
						    +--------+    PACKET_OTHERHOST (set by driver)   +-----------------+
						    | ip_rcv |-------------------------------------->| drop this packet|
						    +--------+                                       +-----------------+
							|
							|
							↓
					      +---------------------+
					      | NF_INET_PRE_ROUTING |
					      +---------------------+
							|
							|
							↓
						    +---------+
						    |         | enabled ip forword  +------------+        +----------------+
						    | routing |-------------------->| ip_forward |------->| NF_INET_FOWARD |
						    |         |                     +------------+        +----------------+
						    +---------+                                                   |
							|                                                         |
							| destination IP is local                                 ↓
							↓                                                 +---------------+
					       +------------------+                                       | dst_output_sk |
					       | ip_local_deliver |                                       +---------------+
					       +------------------+
							|
							|
							↓
					     +------------------+
					     | NF_INET_LOCAL_IN |
					     +------------------+
							|
							|
							↓
						  +-----------+
						  | UDP layer |
						  +-----------+
						    |
						    |
					            ↓
					       +---------+            +-----------------------+
					       | udp_rcv |----------->| __udp4_lib_lookup_skb |
					       +---------+            +-----------------------+
					            |
					            |
						    ↓
					+--------------------+      +-----------+
					| sock_queue_rcv_skb |----->| sk_filter |
					+--------------------+      +-----------+
						    |
					            |
						    ↓
				           +------------------+
					   | __skb_queue_tail |
					   +------------------+
						    |
						    |
					            ↓
					   +---------------+
				           | sk_data_ready |
				           +---------------+
```

